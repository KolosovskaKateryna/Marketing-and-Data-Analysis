Query
WITH user_sessions AS (
  SELECT
    user_pseudo_id || CAST((SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id') AS STRING) AS user_session_id,
    
    SUM(COALESCE((SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'engagement_time_msec'), 0)) AS total_engagement_time,
    
    CASE
      WHEN SUM(COALESCE(SAFE_CAST((SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'session_engaged') AS INT64), 0)) > 0
      THEN 1
      ELSE 0
    END AS is_session_engaged

  FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  GROUP BY user_session_id
),

purchases AS (
  SELECT
    user_pseudo_id || CAST((SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id') AS STRING) AS user_session_id
  FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  WHERE event_name = 'purchase'
)

SELECT
  CORR(s.total_engagement_time, CASE WHEN p.user_session_id IS NOT NULL THEN 1 ELSE 0 END) AS correlation_1,
  CORR(s.is_session_engaged, CASE WHEN p.user_session_id IS NOT NULL THEN 1 ELSE 0 END) AS correlation_2
FROM user_sessions s
LEFT JOIN purchases p USING (user_session_id)

