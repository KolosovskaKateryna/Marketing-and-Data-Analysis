Query
WITH session_starts AS (
  SELECT
    CONCAT(user_pseudo_id, '.', CAST((SELECT value.int_value
                                      FROM UNNEST(event_params)
                                      WHERE key = 'ga_session_id') AS STRING)) AS session_id,
    REPLACE((SELECT value.string_value
             FROM UNNEST(event_params)
             WHERE key = 'page_location'),
            'https://shop.googlemerchandisestore.com/', '') AS page_path
  FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  WHERE _TABLE_SUFFIX BETWEEN '20200101' AND '20201231'
    AND event_name = 'session_start'
),
purchase_sessions AS (
  SELECT DISTINCT
    CONCAT(user_pseudo_id, '.', CAST((SELECT value.int_value
                                      FROM UNNEST(event_params)
                                      WHERE key = 'ga_session_id') AS STRING)) AS session_id
  FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  WHERE _TABLE_SUFFIX BETWEEN '20200101' AND '20201231'
    AND event_name = 'purchase'
)
SELECT
  s.page_path,
  COUNT(DISTINCT s.session_id) AS unique_sessions,
  COUNT(DISTINCT p.session_id) AS purchases,
  ROUND(SAFE_DIVIDE(COUNT(DISTINCT p.session_id), COUNT(DISTINCT s.session_id)), 4) AS conversion_rate
FROM session_starts s
LEFT JOIN purchase_sessions p
  ON s.session_id = p.session_id
GROUP BY s.page_path
ORDER BY unique_sessions DESC

